---
title: "Nest estimations"
output: html_notebook
---

This analysis tries to fill in missing nest counts data. A parametric model is fitted to years with complete data. The estimated parameters are used to fill in years without complete data.

```{r echo=FALSE}
# Get data first and manipulate them:
rm(list=ls())
source('Dc_Indonesia_nesting_fcns.R')
library(lme4)
library(mgcv)
library(rjags)
library(bayesplot)
save.fig <- F

# get JM data first:
data.0.JM <- read.csv('data/NestCounts_JM_09Feb2018.csv')

# create time-duration filed (in yrs)
# define dates with begin and end dates:
data.0.JM %>% reshape2::melt(id.vars = "YEAR", 
                             variable.name = "month",
                             value.name = "count") -> data.1.JM
data.1.JM$MONTH <- unlist(lapply(data.1.JM$month, FUN = mmm2month))

data.1.JM <- mutate(data.1.JM, f.month = as.factor(MONTH),
                    f.year = as.factor(YEAR))  %>%
  mutate(Frac.Year = YEAR + (MONTH-0.5)/12) %>%
  reshape::sort_df(.,vars = "Frac.Year")

data.1.2005.JM <- filter(data.1.JM, YEAR > 2004)

```

Take a look at the data:


```{r warning=FALSE}
p1 <- ggplot(data.1.JM) + 
  geom_point(aes(x = MONTH, y = count, color = f.year)) + 
  geom_line(aes(x = MONTH, y = count, color = f.year)) +
  scale_x_continuous(breaks = seq(1, 12, 1)) +
  labs(x = 'Month', y = '# nests')  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))
p1
```

Take a look at the time series since 2001, and for JM only. 

```{r warning=FALSE}
#data.1.JM %>% mutate(Frac.Year = YEAR + (MONTH-0.5)/12) -> data.1.JM
data.1.JM.2001 <- filter(data.1.JM, YEAR > 2000)
p2 <- ggplot(data.1.JM.2001) + 
  geom_point(aes(x = Frac.Year, y = count)) + 
  geom_line(aes(x = Frac.Year, y = count)) +
  scale_x_continuous(breaks = seq(2000, 2018, 5),
                     limits = c(2000, 2018)) +
  labs(x = 'Time', y = '# nests')  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))
p2
```

Using the cyclic nature of nesting, we should be able to fit a model to fill in the missing data points. We need to make some assumptions about how data were collected, unless we have a measure of effort every year.  

```{r cache=TRUE, echo=FALSE, results='hide', fig.keep='all'}
# run a Bayesian AR1
n.chains <- 3
n.iter <- 10000
n.update <- 10000

data.1.JM.2005 <- filter(data.1.JM, YEAR > 2004)

bugs.data <- list(y = data.1.JM.2005$count,
                  T = 156)
load.module('dic')
load.module('glm')
inits.function <- function(){
  #eps <- rnorm(1, 0, 100)
  theta <- rnorm(1, 0, 100)
  c <- rnorm(1, 0, 100)
  A <- list(theta = theta, c = c)
  return(A)
}

#inits.list <- vector(mode = 'list', length = n.chains)
# inits.values <- lapply(inits.list, 
#                        FUN = inits.function)

jm <- jags.model(file = 'models/model_AR1.txt',
                 data = bugs.data,
                 inits = inits.function,
                 n.chains = n.chains,
                 n.adapt = n.iter)

params <- c('c', 'theta', 'sigma', 'y', 'deviance')

zm <- coda.samples(jm,
                   variable.names = params,
                   n.iter = n.iter)

# these should be done without pulling out ys - not meaningful with ys
# gelman.diag(zm)
# plot(zm)
summary.zm <- summary(zm)

# extract ys
ys.stats <- data.frame(summary.zm$quantiles[grep(pattern = 'y[/[]',
                                                 row.names(summary.zm$quantiles)),
                                            c('2.5%', '50%', '97.5%')])

colnames(ys.stats) <- c('lowN', 'modeN', 'highN')
ys.stats$time <- data.1.JM.2005$Frac.Year

p3 <- ggplot() + 
  geom_point(data = data.1.JM.2005,
             aes(x = Frac.Year, y = count),
             size = 2) + 
  geom_line(data = data.1.JM.2005,
            aes(x = Frac.Year, y = count),
            size = 2) +
  geom_point(data = ys.stats,
             aes(x = time, y = modeN),
             color = 'red') + 
  geom_line(data = ys.stats,
            aes(x = time, y = modeN),
            color = 'red') + 
  
  scale_x_continuous(breaks = seq(2004, 2018, 5),
                     limits = c(2004, 2018)) +
  labs(x = 'Time', y = '# nests')  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))
p3

```

This, however, puts CIs of estimated observations negative, which is not really good. So, an alternative maybe to put lower bound on ys. Here is another look. 

```{r echo=FALSE}
jm <- jags.model(file = 'models/model_AR1_Trunc.txt',
                 data = bugs.data,
                 n.chains = n.chains,
                 n.adapt = n.iter)

params <- c('c', 'theta', 'sigma')
zm <- coda.samples(jm,
                   variable.names = params,
                   n.iter = n.iter)

# these should be done without pulling out ys - not meaningful with ys
gelman.diag(zm)

p.dens <- mcmc_dens(zm, c('c', 'theta', 'sigma'))

params <- c(params, 'y', 'deviance')
zm <- coda.samples(jm,
                   variable.names = params,
                   n.iter = n.iter)

# plot(zm)
summary.zm <- summary(zm)

# extract ys
ys.stats <- data.frame(summary.zm$quantiles[grep(pattern = 'y[/[]',
                                                 row.names(summary.zm$quantiles)),
                                            c('2.5%', '50%', '97.5%')])

colnames(ys.stats) <- c('lowN', 'modeN', 'highN')
ys.stats$time <- data.1.JM.2005$Frac.Year

p3 <- ggplot() + 
  geom_point(data = data.1.JM.2005,
             aes(x = Frac.Year, y = count),
             size = 2) + 
  geom_line(data = data.1.JM.2005,
            aes(x = Frac.Year, y = count),
            size = 2) +
  geom_point(data = ys.stats,
             aes(x = time, y = modeN),
             color = 'red') + 
  geom_line(data = ys.stats,
            aes(x = time, y = modeN),
            color = 'red') + 
  geom_line(data = ys.stats,
            aes(x = time, y = highN),
            color = 'red', linetype = 2) +
  scale_x_continuous(breaks = seq(2004, 2018, 5),
                     limits = c(2004, 2018)) +
  labs(x = 'Time', y = '# nests')  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

p.dens
p3

```

But... the confidence intervals for the winter time are just to high! There is only one variance term and it includes the entire year so summer and winter variability is not considered separately. To do that... we need to add another variance term in the model. Why not move to the Bayesian state-space approach...?

Here is a state-space approach using AR(1) process and using month as the indicator for picking one of two variances in the process. Because it takes a bit of time to run these, output has been saved as an RData file. Bring it in and make some plots here.

```{r}
load("RData/SSAR1_month_JM_2018-03-29.RData")

JM.summary.zm <- summary(results.JM_SSAR1_month$zm)

# extract ys
JM.ys.stats <- data.frame(JM.summary.zm$quantiles[grep(pattern = 'y[/[]',
                                                 row.names(JM.summary.zm$quantiles)),
                                            c('2.5%', '50%', '97.5%')])

colnames(JM.ys.stats) <- c('low_y', 'mode_y', 'high_y')
JM.ys.stats$time <- results.JM_SSAR1_month$data.1$Frac.Year
JM.ys.stats$obsY <- results.JM_SSAR1_month$data.1$count

# extract Xs - the state model
JM.Xs.stats <- data.frame(JM.summary.zm$quantiles[grep(pattern = 'X[/[]',
                                                 row.names(JM.summary.zm$quantiles)),
                                            c('2.5%', '50%', '97.5%')])
colnames(JM.Xs.stats) <- c('low_X', 'mode_X', 'high_X')
JM.Xs.stats$time <- results.JM_SSAR1_month$data.1$Frac.Year
JM.Xs.stats$obsY <- results.JM_SSAR1_month$data.1$count

mcmc_dens(results.JM_SSAR1_month$zm, c("theta", "sigma.pro1", "sigma.pro2"))

ggplot(data = JM.Xs.stats) +
  geom_point(aes(x = time, y = mode_X), color = "blue") +
  geom_line(aes(x = time, y = mode_X), color = 'blue') +
  geom_line(aes(x = time, y = high_X), color = "blue", 
            linetype = 2) +
  geom_point(aes(x = time, y = mode_X), color = "red",
             alpha = 0.5) + 
  geom_line(aes(x = time, y = mode_X), color = "red",
            alpha = 0.5) + 
  geom_point(aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  geom_line(aes(x = time, y = obsY), color = "green",
             alpha = 0.5) 

rm(list = c('results.JM_SSAR1_month'))
#save(zm, summary.zm, ys.stats, Xs.stats, data.1.JM.2005, 
#     file = 'RData/SSAR1_month.RData')
```

I used a similar approach to the Warmon dataset also but changed the time frames for two variances; one variance for Jan through September and another for October, November, and December.

```{r}
load("RData/SSAR1_month_Warmon_2018-03-29.RData")

W.summary.zm <- summary(results.Warmon_SSAR1_month$zm)

# extract ys
W.ys.stats <- data.frame(W.summary.zm$quantiles[grep(pattern = 'y[/[]',
                                                 row.names(W.summary.zm$quantiles)),
                                            c('2.5%', '50%', '97.5%')])

colnames(W.ys.stats) <- c('low_y', 'mode_y', 'high_y')
W.ys.stats$time <- results.Warmon_SSAR1_month$data.1$Frac.Year
W.ys.stats$obsY <- results.Warmon_SSAR1_month$data.1$count

# extract Xs - the state model
W.Xs.stats <- data.frame(W.summary.zm$quantiles[grep(pattern = 'X[/[]',
                                                 row.names(W.summary.zm$quantiles)),
                                            c('2.5%', '50%', '97.5%')])
colnames(W.Xs.stats) <- c('low_X', 'mode_X', 'high_X')
W.Xs.stats$time <- results.Warmon_SSAR1_month$data.1$Frac.Year
W.Xs.stats$obsY <- results.Warmon_SSAR1_month$data.1$count

mcmc_dens(results.Warmon_SSAR1_month$zm, c("theta", "sigma.pro1", "sigma.pro2"))

ggplot(data = W.Xs.stats) +
  geom_point(aes(x = time, y = mode_X), color = "blue") +
  geom_line(aes(x = time, y = mode_X), color = 'blue') +
  geom_line(aes(x = time, y = high_X), color = "blue", 
            linetype = 2) +
  geom_point(aes(x = time, y = mode_X), color = "red",
             alpha = 0.5) + 
  geom_line(aes(x = time, y = mode_X), color = "red",
            alpha = 0.5) + 
  geom_point(aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  geom_line(aes(x = time, y = obsY), color = "green",
             alpha = 0.5) 

rm(list = c('results.Warmon_SSAR1_month'))
```

