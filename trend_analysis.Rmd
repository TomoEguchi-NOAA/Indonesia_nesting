---
title: "Trend analysis"
output: html_notebook
---

```{r}
rm(list=ls())
library(jagsUI)
library(coda)
library(tidyverse)
source("Dc_Indonesia_nesting_fcns.R")

# the date jags was run (run_JM_SSAR1_logY.R and run_W_SSAR1_logY.R)
run.date <- "2019-03-14"

# MCMC setup - comments are from Summer Martin. Thinning isn't really necessary... but
# good to reduce the output file size. 
n.samples <- 250000   
mcmc.chains <- 5     # 2 is min; AY uses 3
mcmc.thin <- 50      # 50-100 is more than safe; 500 seems excessive per AY
mcmc.burn <- 5000    # 1000; also bumped up to 5000 (same as n.samples) per CB after geweke.diag for deviance in chain 1 still looked high at 2.2
#samples2Save <- (mcmc.burn + n.samples) * mcmc.thin

MCMC.params <- list(n.chains = mcmc.chains,
                    n.samples = n.samples,
                    n.burnin = mcmc.burn,
                    n.thin = mcmc.thin)

# analysis constants
# years to be analyzed for Jamursba-Medi and Wermon
begin.year <- 2001
end.year <- 2018

JM.yrs <- 2001:2018
W.yrs <- 2006:2018

JM.bestM <- 8
W.bestM <- 7

fill.color <-  "darkseagreen"
fill.alpha <-  0.65
line.color <-  "darkblue"
data.color <- "black"
data.size <- 1.5
obsd.color <- "red"
obsd.size <- 1
```


This document describes trend analysis of leatherback turtles at nesting beaches in Indonesia. Bayesian state-space time series analyses, which were developed for HI longline fisheries Biological Opinions, were used to estimate the population growth rates.  Code was obtained from Summer Martin, whose code was based on Boyd et al. (2016?)

Raw data:

```{r data_filter, cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

data.0.JM <- data.extract(location = "JM", year.begin = 1981, year.end = 2019)

data.0.JM$data.1 %>% 
  mutate(f_month = as.factor(Month),
         f_year = as.factor(Year),
         Season = ifelse(Month < 4, Year - 1, Year),
         season = ifelse(Month > 3 & Month < 10, 
                         "summer", "winter")) -> data.1.JM

```


### Jamursba-Medi
```{r JM_data, cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
p.JM.all <- ggplot(data.1.JM) + 
  geom_point(aes(x = Frac.Year, y = Nests)) + 
  geom_line(aes(x = Frac.Year, y = Nests)) +
  scale_x_continuous(breaks = seq(1980, 2020, 5),
                     limits = c(1980, 2020)) +
  labs(x = '', y = '# nests', title = "Jamursba-Medi")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

#print(p.JM.all)
ggsave(filename = 'figures/JM_all.png',
       plot = p.JM.all,
       dpi = 600, height = 6, width = 8, units = "in")
```

At Jamursba-Medi, there were many years of no data collection between the mid 1980s and late 1990s. A somewhat consistent effort starts in early 2000s and continue to recent years. 

```{r plot_JM_raw_data, echo=FALSE, cache=TRUE, fig.cap = "Figure 1. Nest counts at Jamursba-Medi"}
knitr::include_graphics("figures/JM_all.png")
```

No data were collected in 1998. Since then at least some data were collected within each year. After analyzing datasets with different starting years, we found that starting at 1999 resulted in the longest dataset and good convergence of MCMC.  Consequently, we decided to use data since 1999. The cyclical nature or seaonal fluctuations of counts is obvious in the raw counts.

```{r JM_raw_since_1999, echo=FALSE, cache=TRUE, warning=FALSE}
data.1.JM.1999 <- filter(data.1.JM, Frac.Year > 1998)
p.JM.1999 <- ggplot(data.1.JM.1999) + 
  geom_point(aes(x = Frac.Year, y = Nests)) + 
  geom_line(aes(x = Frac.Year, y = Nests)) +
  scale_x_continuous(breaks = seq(1999, 2019, 5),
                     limits = c(1999, 2019)) +
  labs(x = '', y = '# nests', 
       title = "Jamursba-Medi")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

ggsave(filename = 'figures/JM_1999.png',
       plot = p.JM.1999,
       dpi = 600, height = 6, 
       width = 8, units = "in")
```

```{r plot_JM_raw_since_1999, echo=FALSE, cache=TRUE, fig.cap = "Figure 2. Nest counts at Jamursba-Medi since 1999"}
knitr::include_graphics("figures/JM_1999.png")
```


```{r JM_raw_by_month, echo=FALSE, cache = TRUE, warning=FALSE}
p.JM.monthly.1999 <- ggplot(data.1.JM.1999) + 
  geom_point(aes(x = Month, y = Nests, color = f_year)) + 
  geom_line(aes(x = Month, y = Nests, color = f_year)) +
  scale_x_continuous(breaks = seq(1, 12, 1)) +
  labs(x = 'Month', y = '# nests', 
       title = "Jamursba-Medi", color = "Year")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))
#        legend.position = c(0.9, 0.6))

ggsave(filename = 'figures/JM_monthly_1999.png', 
       plot = p.JM.monthly.1999,
       dpi = 600, height = 6, 
       width = 8, units = "in")
```

When the number of nests is plotted by month, the seasonal fluctations become more obvious (Figure 3). In general, high counts within a year are seen during summer months (approximately from April to September), whereas low counts are found during winter months (October through March).   

```{r plot_JM_by_month, echo=FALSE, cache=TRUE, fig.cap = "Figure 3. Monthly nest counts at Jamursba-Medi"}
knitr::include_graphics("figures/JM_monthly_1999.png")
```

###Wermon
```{r W_data, cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
data.0.W <- data.extract(location = "W", year.begin = 2002, year.end = 2019)

data.0.W$data.1 %>% 
  mutate(f_month = as.factor(Month),
         f_year = as.factor(Year),
         Season = ifelse(Month < 4, Year - 1, Year),
         season = ifelse(Month > 3 & Month < 10, 
                         "summer", "winter")) -> data.1.W

p.W.all <- ggplot(data.1.W) + 
  geom_point(aes(x = Frac.Year, y = Nests)) + 
  geom_line(aes(x = Frac.Year, y = Nests)) + 
  labs(title = 'Wermon', x = '', 
       y = "Nest counts")

ggsave(filename = 'figures/W_all.png', 
       plot = p.W.all,
       dpi = 600, height = 6, 
       width = 8, units = "in")
```

At Wermon, the sole data point in 2002 was from at least two months. So, for this analysis, I use data from 2003.  Limited amount of data were collected between July 2013 and December 2015.    

```{r plot_W_all, echo=FALSE, cache=TRUE, fig.cap = "Figure 4. Nest counts at Wermon. "}
knitr::include_graphics("figures/W_all.png")
```

The temporal nest count pattern at Wermon is different from that of Jamursba-Medi (Figure 3 vs. Figure 5). At Wermon, there are two peaks annually: higher values are found between May and September and between October and April.  

```{r W_raw_by_month, echo=FALSE, cache = TRUE, warning=FALSE}
data.1.W %>% filter(Year > 2002) -> data.1.W.2003

p.W.monthly <- ggplot(data.1.W.2003) + 
  geom_point(aes(x = Month, y = Nests, color = f_year)) + 
  geom_line(aes(x = Month, y = Nests, color = f_year)) +
  scale_x_continuous(breaks = seq(1, 12, 1)) +
  labs(x = 'Month', y = '# nests', title = "Wermon",
       color = "Year")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

ggsave(filename = 'figures/W_monthly.png', 
       plot = p.W.monthly,
       dpi = 600, height = 6, 
       width = 8, units = "in")

```

```{r plot_W_by_month, echo=FALSE, cache=TRUE, fig.cap = "Figure 5. Monthly nest counts at Wermon. "}
knitr::include_graphics("figures/W_monthly.png")
```

Observed counts for 2004 and 2005 seem to be outliers with respect to within-year patterns. Because this analysis is to estimate missing values from observed patterns, we remove these years from the data for the following analysis.  

```{r W_by_month_since_2006, echo=FALSE, cache = TRUE, warning=FALSE}
data.1.W %>% filter(Year > 2005) -> data.1.W.2006

p.W.monthly.2006 <- ggplot(data.1.W.2006) + 
  geom_point(aes(x = Month, y = Nests, color = f_year)) + 
  geom_line(aes(x = Month, y = Nests, color = f_year)) +
  scale_x_continuous(breaks = seq(1, 12, 1)) +
  labs(x = 'Month', y = '# nests', title = "Wermon",
       color = "Year")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

ggsave(filename = 'figures/W_monthly_2006.png', 
       plot = p.W.monthly.2006,
       dpi = 600, height = 6, 
       width = 8, units = "in")
```


```{r plot_W_by_month_since_2006, echo=FALSE, cache=TRUE, fig.cap = "Figure 6. Monthly nest counts at Wermon since 2006. "}
knitr::include_graphics("figures/W_monthly_2006.png")
```


Imputations were conducted in NestCountsImputation_JM_Rmd and NestCountsImputation_W.Rmd. From here, data are annual number of females or nests. These data were computed   

```{r}
JM <- read.csv(paste0("data/estimatedX_JM_M", JM.bestM, "_", run.date, ".csv"), 
                header=T)
JMdat <- JM[which(JM$season %in% JM.yrs), ]


W <- read.csv(paste0("data/estimatedX_W_M", W.bestM, "_", run.date, ".csv"), 
              header=T)  # Jamursba Medi (1 peak nesting in summer)

Wdat <- W[which(W$season %in% W.yrs), ]   # only keep specific data years 
#Wdat[which(Wdat$season %in% 2013:2015) , 
#     c("Summer.median", "Winter.median", "all.median")] <- NA  # for seasons 2013-2015, make data = NA since not using; retains time sequence

# 3. COMBINE JM & W into one dataset with 2 time series and run model on that
thedata <- left_join(JMdat, Wdat, by = "season") %>%
  transmute(Season = season, 
            Summer.median.JM = Summer.median.x, 
            Winter.median.JM = Winter.median.x,
            All.median.JM = all.median.x,
            Summer.median.W = Summer.median.y, 
            Winter.median.W = Winter.median.y,
            All.median.W = all.median.y,
            Summer.observed.JM = summer.x, 
            Winter.observed.JM = winter.x,
            All.observed.JM = summer.x + winter.x,
            Summer.observed.W = summer.y, 
            Winter.observed.W = winter.y,
            All.observed.W = summer.y + winter.y)

```

Once data are filtered, set data up for analysis.

To make a direct comparison with Tapilatu et al. possible, we also look at results of independent Us and a single Q analysis on one datasaet at a time. 

```{r}
log.data.JM <- log(thedata[, "All.median.JM"])     
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(log.data.JM)    # tranpose to have rows = time series and cols = years of data

# Note: The initial state, x0, is treated as a model parameter. 
# the prior matters for Wermon - setting mean to first JM data point skews Wermon to JM trend due to poor W data
# making it specific to each time series for independentUQ

if(!file.exists(paste0("Rdata/singleUQ_JM_only_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_JM_only_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} else {
  jm.out <- readRDS(file = paste0("Rdata/singleUQ_JM_only_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
}

```

```{r}
signif(jm.out$out$summary["U", "f"], 3) * 100
```


```{r}
p.1 <- bayesplot::mcmc_dens(jm.out$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_JM_only.png",
       device = "png",
       dpi = 600)
print(p.1)
```


Then plot the predictions and data. 

```{r}
JM.log.df <- data.frame(median = jm.out$out$q50$X,
                        lower = jm.out$out$q2.5$X,
                        upper = jm.out$out$q97.5$X,
                        data = jm.out$jags.data$Y[1,],
                        obsd = log(thedata$All.observed.JM),
                        time = thedata$Season,
                        loc = 1)

JM.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> JM.df

p.1.log <- ggplot(data = JM.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Jamursba-Medi")

ggsave(p.1.log, filename = "figures/JM_only_trend_annual_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = JM.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Jamursba-Medi")

ggsave(p.1, filename = "figures/JM_only_trend_annual.png",
       device = "png", dpi = 600)

p.1
```

Look at the summer only
```{r}
log.data.JM <- log(thedata[, "Summer.median.JM"])     
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(log.data.JM)    # tranpose to have rows = time series and cols = years of data

# Note: The initial state, x0, is treated as a model parameter. 
# the prior matters for Wermon - setting mean to first JM data point skews Wermon to JM trend due to poor W data
# making it specific to each time series for independentUQ

if(!file.exists(paste0("Rdata/singleUQ_JM_only_summer_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_JM_only_summer_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} else {
  jm.out <- readRDS(file = paste0("Rdata/singleUQ_JM_only_summer_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
}

```

```{r}
signif(jm.out$out$summary["U", "f"], 3) * 100
```


```{r}
p.1 <- bayesplot::mcmc_dens(jm.out$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_JM_only_summer.png",
       device = "png",
       dpi = 600)
print(p.1)
```

Then plot the predictions and data. 

```{r}
JM.log.df <- data.frame(median = jm.out$out$q50$X,
                        lower = jm.out$out$q2.5$X,
                        upper = jm.out$out$q97.5$X,
                        data = jm.out$jags.data$Y[1,],
                        obsd = log(thedata$Summer.observed.JM),
                        time = thedata$Season,
                        loc = 1)

JM.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> JM.df

p.1.log <- ggplot(data = JM.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Jamursba-Medi (Summer)")

ggsave(p.1.log, filename = "figures/JM_only_trend_summer_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = JM.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Jamursba-Medi (Summer)")

ggsave(p.1, filename = "figures/JM_only_trend_summer.png",
       device = "png", dpi = 600)

p.1
```

Look at the winter only
```{r}
log.data.JM <- log(thedata[, "Winter.median.JM"])     
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(log.data.JM)    # tranpose to have rows = time series and cols = years of data

# Note: The initial state, x0, is treated as a model parameter. 
# the prior matters for Wermon - setting mean to first JM data point skews Wermon to JM trend due to poor W data
# making it specific to each time series for independentUQ

if(!file.exists(paste0("Rdata/singleUQ_JM_only_winter_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_JM_only_winter_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} else {
  jm.out <- readRDS(file = paste0("Rdata/singleUQ_JM_only_winter_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
}

```

```{r}
signif(jm.out$out$summary["U", "f"], 3) * 100
```


```{r}
p.1 <- bayesplot::mcmc_dens(jm.out$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_JM_only_winter.png",
       device = "png",
       dpi = 600)
print(p.1)
```

Then plot the predictions and data. 

```{r}
JM.log.df <- data.frame(median = jm.out$out$q50$X,
                        lower = jm.out$out$q2.5$X,
                        upper = jm.out$out$q97.5$X,
                        data = jm.out$jags.data$Y[1,],
                        obsd = log(thedata$Winter.observed.JM),
                        time = thedata$Season,
                        loc = 1)

JM.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> JM.df

p.1.log <- ggplot(data = JM.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Jamursba-Medi (Winter)")

ggsave(p.1.log, filename = "figures/JM_only_trend_winter_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = JM.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Jamursba-Medi (Winter)")

ggsave(p.1, filename = "figures/JM_only_trend_winter.png",
       device = "png", dpi = 600)

p.1
```


Then Wermon for both seasons combined.

```{r}
log.data.W <- log(thedata[, "All.median.W"])     
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(na.omit(log.data.W))    # tranpose to have rows = time series and cols = years of data

# Note: The initial state, x0, is treated as a model parameter. 
# the prior matters for Wermon - setting mean to first JM data point skews Wermon to JM trend due to poor W data
# making it specific to each time series for independentUQ

if(!file.exists(paste0("Rdata/singleUQ_W_only_2006_", 
                       end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_W_only_2006_", 
                                end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} else {
  jm.out <- readRDS(file = paste0("Rdata/singleUQ_W_only_2006_", 
                                end.year,  "_", run.date, ".rds"))
}

```

```{r}
signif(jm.out$out$summary["U", "f"], 3) * 100
```


```{r}
p.1 <- bayesplot::mcmc_dens(jm.out$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_W_only.png",
       device = "png",
       dpi = 600)
print(p.1)
```

Then plot the predictions and data. 

```{r}
W.log.df <- data.frame(median = jm.out$out$q50$X,
                        lower = jm.out$out$q2.5$X,
                        upper = jm.out$out$q97.5$X,
                        data = jm.out$jags.data$Y[1,],
                        obsd = log(thedata$All.observed.W[6:18]),
                        time = thedata$Season[6:18],
                        loc = 1)

W.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> W.df

p.1.log <- ggplot(data = W.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2006, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Wermon")

ggsave(p.1.log, filename = "figures/W_only_trend_annual_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = W.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2006, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Wermon")

ggsave(p.1, filename = "figures/W_only_trend_annual.png",
       device = "png", dpi = 600)

p.1
```

Summer only for Wermon.

```{r}
log.data.W <- log(thedata[, "Summer.median.W"])     
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(na.omit(log.data.W))    # tranpose to have rows = time series and cols = years of data

# Note: The initial state, x0, is treated as a model parameter. 
# the prior matters for Wermon - setting mean to first JM data point skews Wermon to JM trend due to poor W data
# making it specific to each time series for independentUQ

if(!file.exists(paste0("Rdata/singleUQ_W_only_summer_2006_", 
                       end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_W_only_summer_2006_", 
                                end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} else {
  jm.out <- readRDS(file = paste0("Rdata/singleUQ_W_only_summer_2006_", 
                                end.year,  "_", run.date, ".rds"))
}

```

```{r}
signif(jm.out$out$summary["U", "f"], 3) * 100
```


```{r}
p.1 <- bayesplot::mcmc_dens(jm.out$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_W_only_summer.png",
       device = "png",
       dpi = 600)
print(p.1)
```

Then plot the predictions and data. 

```{r}
W.log.df <- data.frame(median = jm.out$out$q50$X,
                        lower = jm.out$out$q2.5$X,
                        upper = jm.out$out$q97.5$X,
                        data = jm.out$jags.data$Y[1,],
                        obsd = log(thedata$Summer.observed.W[6:18]),
                        time = thedata$Season[6:18],
                        loc = 1)

W.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> W.df

p.1.log <- ggplot(data = W.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2006, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Wermon (Summer)")

ggsave(p.1.log, filename = "figures/W_only_trend_summer_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = W.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2006, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Wermon (Summer)")

ggsave(p.1, filename = "figures/W_only_trend_summer.png",
       device = "png", dpi = 600)

p.1
```

Then Winter only.

```{r}
log.data.W <- log(thedata[, "Winter.median.W"])     
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(na.omit(log.data.W))    # tranpose to have rows = time series and cols = years of data

# Note: The initial state, x0, is treated as a model parameter. 
# the prior matters for Wermon - setting mean to first JM data point skews Wermon to JM trend due to poor W data
# making it specific to each time series for independentUQ

if(!file.exists(paste0("Rdata/singleUQ_W_only_winter_2006_", 
                       end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_W_only_winter_2006_", 
                                end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} else {
  jm.out <- readRDS(file = paste0("Rdata/singleUQ_W_only_winter_2006_", 
                                end.year,  "_", run.date, ".rds"))
}

```

```{r}
signif(jm.out$out$summary["U", "f"], 3) * 100
```


```{r}
p.1 <- bayesplot::mcmc_dens(jm.out$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_W_only_winter.png",
       device = "png",
       dpi = 600)
print(p.1)
```

Then plot the predictions and data. 

```{r}
W.log.df <- data.frame(median = jm.out$out$q50$X,
                        lower = jm.out$out$q2.5$X,
                        upper = jm.out$out$q97.5$X,
                        data = jm.out$jags.data$Y[1,],
                        obsd = log(thedata$Winter.observed.W[6:18]),
                        time = thedata$Season[6:18],
                        loc = 1)

W.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> W.df

p.1.log <- ggplot(data = W.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2006, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Wermon (Winter)")

ggsave(p.1.log, filename = "figures/W_only_trend_winter_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = W.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2006, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Wermon (Winter)")

ggsave(p.1, filename = "figures/W_only_trend_winter.png",
       device = "png", dpi = 600)

p.1
```

Rather than splitting the dataset in two, we can use the data from the two beach simultaneously. using independent-U and single-Q or independent-Q model output. Using the simpler of the two:

```{r}
jags.model <- readRDS(file = "RData/independentUs_singleQ_out_2001_2018_2019-03-14.rds")
```


Look at the slope parameters for JM (1) and W (2)
```{r}

p.1 <- bayesplot::mcmc_dens(jags.model$out$samples, c("U[1]", "U[2]"))
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_Us.png",
       device = "png",
       dpi = 600)
print(p.1)

```

```{r}
# proportion of U[1] less than 0.
signif(jags.model$out$summary["U[1]", "f"], 3) * 100
```


```{r}
# proportion of U[2] less than 0.
signif(jags.model$out$summary["U[2]", "f"], 3) * 100
```


```{r}
jags.data <- jags.model$jags.data
# create a dataframe for plotting - need median, upper, and lower 95% limits for each 
# pop
JM.log.df <- data.frame(median = jags.model$out$q50$X[1,],
                        lower = jags.model$out$q2.5$X[1,],
                        upper = jags.model$out$q97.5$X[1,],
                        data = jags.model$jags.data$Y[1,],
                        obsd = log(thedata$All.observed.JM),
                        time = thedata$Season,
                        loc = 1)

JM.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> JM.df

p.1.log <- ggplot(data = JM.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Jamursba-Medi")

ggsave(p.1.log, filename = "figures/JM_trend_annual_indU_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = JM.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Jamursba-Medi")

ggsave(p.1, filename = "figures/JM_trend_annual_indU.png",
       device = "png", dpi = 600)

p.1
```

```{r}
W.log.df <- data.frame(median = jags.model$out$q50$X[2,],
                   lower = jags.model$out$q2.5$X[2,],
                   upper = jags.model$out$q97.5$X[2,],
                   data = jags.model$jags.data$Y[2,],
                   obsd = log(thedata$All.observed.W),
                   time = thedata$Season,
                   loc = 2)

W.log.df %>% transmute(median = exp(median),
                               lower = exp(lower),
                               upper = exp(upper),
                               data = exp(data),
                               time = time,
                               obsd = exp(obsd),
                               loc = loc) -> W.df

p.2.log <- ggplot(data = W.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "ln(nests)", title = "Wermon")

ggsave(p.2.log, filename = "figures/W_trend_annual_indU_log.png",
       device = "png", dpi = 600)

p.2 <- ggplot(data = W.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "Nests", title = "Wermon")

ggsave(p.2, filename = "figures/W_trend_annual_indU.png",
       device = "png", dpi = 600)

print(p.2)
```

Here we start the analysis with two datasets together and compare models.
First one is Jamusrba-Medi and Wermon combined with a common trend (U) and one process variance (Q)

We need to set up data with two time series. 
```{r}
# Transform data into natural log (Ln) space and PLOT DATA
#log.data <- log(thedata[, c("median_JM", "median_W")])     
log.data <- log(thedata[, c("All.median.JM", "All.median.W")])     
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(log.data)    # tranpose to have rows = time series and cols = years of data

# Note: The initial state, x0, is treated as a model parameter. 
# the prior matters for Wermon - setting mean to first JM data point skews Wermon to JM trend due to poor W data
# making it specific to each time series for independentUQ


```

Then run all four models. 
```{r}
  
if(!file.exists(paste0("Rdata/singleUQ_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_out_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} 

```


In the second model, both U (slope) and Q (process variance) are independent between the two time series. 
```{r}
# Model 2:  'independentUQs' ... multiple time series -> multiple population processes (trends)

if(!file.exists(paste0("Rdata/independentUQ_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- paste("models/model_independentUQs.txt", sep="")
  
  # Run model
  set.seed <- 132

  jm.out <- run.independentUQ(dat, 
                              jags.params, 
                              model.loc, 
                              MCMC.params, 
                              seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentUQ_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 

```

Model 3 has single slope (U) and location specific process variance (Q).

```{r}
if(!file.exists(paste0("Rdata/independentQs_singleU_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentQs_singleU.txt"
  
  # Run model
  set.seed <- 132
  jm.out <- run.independentQs_singleU(dat, 
                                      jags.params, 
                                      model.loc, 
                                      MCMC.params, 
                                      seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentQs_singleU_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```

Model 4 has single process variance (Q) and location specific slope (U).

```{r}
if(!file.exists(paste0("Rdata/independentUs_singleQ_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentUs_singleQ.txt"
  
  # Run model
  set.seed <- 132
  jm.out <- run.independentUs_singleQ(dat, 
                                      jags.params, 
                                      model.loc, 
                                      MCMC.params, 
                                      seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentUs_singleQ_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```


Once the four models are run, we compare these using DIC. I haven't figured out how to use looic for this dataset because of missing data points and multi-dimensional likelihood values.  I think I can just treat them as independent values but that requires converting sizes of the log likelihood matrix... so, that's not done yet.

```{r}
tmp <- readRDS(paste0("RData/singleUQ_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U1Q1.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentQs_singleU_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U1Q2.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentUQ_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U2Q2.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentUs_singleQ_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U2Q1.DIC <- tmp$out$DIC

c(U1Q1.DIC, U1Q2.DIC, U2Q2.DIC, U2Q1.DIC)

#minimum is U1Q1
```

Using the simplest model results in the lowest DIC value. So, use that for the following seciton.

```{r}
jags.model <- readRDS(paste0("RData/singleUQ_out_", 
                             begin.year, "_", end.year, 
                             "_", run.date, ".rds"))

jags.data <- jags.model$jags.data
# create a dataframe for plotting - need median, upper, and lower 95% limits for each 
# pop
JM.log.df <- data.frame(median = jags.model$out$q50$X,
                        lower = jags.model$out$q2.5$X,
                        upper = jags.model$out$q97.5$X,
                        data = jags.model$jags.data$Y[1,],
                        obsd = log(thedata$All.observed.JM),
                        time = thedata$Season,
                        loc = 1)

JM.log.df %>% transmute(median = exp(median),
                        lower = exp(lower),
                        upper = exp(upper),
                        data = exp(data),
                        time = time,
                        obsd = exp(obsd),
                        loc = loc) -> JM.df

p.1.log <- ggplot(data = JM.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "ln(nests)", title = "Jamursba-Medi")

ggsave(p.1.log, filename = "figures/JM_trend_annual_log.png",
       device = "png", dpi = 600)

p.1 <- ggplot(data = JM.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +   
  labs(x = "", y = "Nests", title = "Jamursba-Medi")

ggsave(p.1, filename = "figures/JM_trend_annual.png",
       device = "png", dpi = 600)

p.1

```

Then for Wermon
```{r}
W.log.df <- data.frame(median = jags.model$out$q50$X + jags.model$out$q50$A[2],
                   lower = jags.model$out$q2.5$X + jags.model$out$q2.5$A[2],
                   upper = jags.model$out$q97.5$X + jags.model$out$q97.5$A[2],
                   data = jags.model$jags.data$Y[2,],
                   obsd = log(thedata$All.observed.W),
                   time = thedata$Season,
                   loc = 2)

W.log.df %>% transmute(median = exp(median),
                               lower = exp(lower),
                               upper = exp(upper),
                               data = exp(data),
                               time = time,
                               obsd = exp(obsd),
                               loc = loc) -> W.df

p.2.log <- ggplot(data = W.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "ln(nests)", title = "Wermon")

ggsave(p.2.log, filename = "figures/W_trend_annual_log.png",
       device = "png", dpi = 600)

p.2 <- ggplot(data = W.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "Nests", title = "Wermon")

ggsave(p.2, filename = "figures/W_trend_annual.png",
       device = "png", dpi = 600)

print(p.2)
```

Look at the posterior of the slope parameter (U).
```{r}
p.1 <- bayesplot::mcmc_dens(jags.model$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_singleU.png",
       device = "png",
       dpi = 600)
print(p.1)
```

```{r}
signif(jags.model$out$summary["U", "f"], 3) * 100
```



Next, we split into summer and winter.
```{r}
# 4. Summer/Winter LEATHERBACKS (again, Tomo's estimates - we are only using medians for now)

# Transform data into natural log (Ln) space and PLOT DATA
log.data <- log(thedata[, c("Summer.median.JM", "Summer.median.W")])   
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(log.data)    # tranpose to have rows = time series and cols = years of data

```

Then run the three models on just summer and winter separately.

```{r}
if(!file.exists(paste0("Rdata/singleUQ_summer_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_summer_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)

} 

```

```{r}
if(!file.exists(paste0("Rdata/independentUQ_summer_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentUQs.txt"
                     
  # Run model
  set.seed <- 132

  jm.out <- run.independentUQ(dat, 
                              jags.params, 
                              model.loc, 
                              MCMC.params, 
                              seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentUQ_summer_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```

```{r}
if(!file.exists(paste0("Rdata/independentQs_singleU_summer_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentQs_singleU.txt"
  
  # Run model
  set.seed <- 132
  jm.out <- run.independentQs_singleU(dat, 
                                      jags.params, 
                                      model.loc, 
                                      MCMC.params, 
                                      seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentQs_singleU_summer_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```

```{r}
if(!file.exists(paste0("Rdata/independentUs_singleQ_summer_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentUs_singleQ.txt"
  
  # Run model
  set.seed <- 132
  jm.out <- run.independentUs_singleQ(dat, 
                                      jags.params, 
                                      model.loc, 
                                      MCMC.params, 
                                      seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentUs_singleQ_summer_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```


```{r}
tmp <- readRDS(paste0("RData/singleUQ_summer_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U1Q1.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentQs_singleU_summer_out_", 
                      begin.year, "_", end.year, "_", run.date,  ".rds"))
U1Q2.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentUQ_summer_out_", 
                      begin.year, "_", end.year, "_", run.date,  ".rds"))
U2Q2.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentUs_singleQ_summer_out_", 
                      begin.year, "_", end.year, "_", run.date,  ".rds"))
U2Q1.DIC <- tmp$out$DIC

c(U1Q1.DIC, U1Q2.DIC, U2Q2.DIC, U2Q1.DIC)

#minimum is U1Q1
```

Using the simplest model results in the lowest DIC value. So, use that for the following seciton.

```{r}
jags.model_summer <- readRDS(paste0("RData/singleUQ_summer_out_", 
                             begin.year, "_", end.year, "_", run.date, ".rds"))
jags.data_summer <- jags.model_summer$jags.data

# create a dataframe for plotting - need median, upper, and lower 95% limits for each 
# pop
JM.summer.log.df <- data.frame(median = jags.model_summer$out$q50$X,
                               lower = jags.model_summer$out$q2.5$X,
                               upper = jags.model_summer$out$q97.5$X,
                               data = jags.model_summer$jags.data$Y[1,],
                               time = thedata$Season,
                               obsd = log(thedata$Summer.observed.JM),
                               loc = 1)

JM.summer.log.df %>% transmute(median = exp(median),
                               lower = exp(lower),
                               upper = exp(upper),
                               data = exp(data),
                               time = time,
                               obsd = exp(obsd),
                               loc = loc) -> JM.summer.df

p.3 <- ggplot(data = JM.summer.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "Nests", title = "Jamursba-Medi (Summer)")

ggsave(p.3, filename = "figures/JM_trend_summer.png",
       device = "png", dpi = 600)

p.3.log <- ggplot(data = JM.summer.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "ln(nests)", title = "Jamursba-Medi (Summer)")

ggsave(p.3.log, filename = "figures/JM_trend_summer_log.png",
       device = "png", dpi = 600)


p.3

```

```{r}
W.summer.log.df <- data.frame(median = jags.model_summer$out$q50$X + jags.model_summer$out$q50$A[2],
                          lower = jags.model_summer$out$q2.5$X + jags.model_summer$out$q2.5$A[2],
                          upper = jags.model_summer$out$q97.5$X + jags.model_summer$out$q97.5$A[2],
                          data = jags.model_summer$jags.data$Y[2,],
                          time = thedata$Season,
                          obsd = log(thedata$Summer.observed.W),
                          loc = 2)

W.summer.log.df %>% transmute(median = exp(median),
                          lower = exp(lower),
                          upper = exp(upper),
                          data = exp(data),
                          time = time,
                          obsd = exp(obsd),
                          loc = loc) -> W.summer.df

p.4 <- ggplot(data = W.summer.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "Nests", title = "Wermon (Summer)")

ggsave(p.4, filename = "figures/W_trend_summer.png",
       device = "png", dpi = 600)

p.4.log <- ggplot(data = W.summer.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "ln(nests)", title = "Wermon (Summer)")

ggsave(p.4.log, filename = "figures/W_trend_summer_log.png",
       device = "png", dpi = 600)

print(p.4)
```

Look at the posterior of the slope parameter (U).
```{r}
p.1 <- bayesplot::mcmc_dens(jags.model_summer$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_summer.png",
       device = "png",
       dpi = 600)
print(p.1)
```

```{r}
signif(jags.model_summer$out$summary["U", "f"], 3) * 100
```


Then winter

```{r}
log.data <- log(thedata[, c("Winter.median.JM", "Winter.median.W")])   
#
# Ln(TOTAL NUMBER OF FEMALES)
dat <- t(log.data)    # tranpose to have rows = time series and cols = years of data

```

Then run the three models on just summer and winter separately.

```{r}
if(!file.exists(paste0("Rdata/singleUQ_winter_out_", 
                       begin.year, "_", end.year, "_", run.date,  ".rds"))){
  jags.params <- c("A", "U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_singleUQ.txt"
  
  # Run model
  seed <- 132
  
  jm.out <- run.singleUQ(dat, 
                         jags.params, 
                         model.loc, 
                         MCMC.params, 
                         seed)
  
  jm.out$data <- thedata
  saveRDS(jm.out, file = paste0("Rdata/singleUQ_winter_out_", 
                                begin.year, "_", end.year,  "_", run.date, ".rds"))
  print(jm.out$out)

} 

```

```{r}
if(!file.exists(paste0("Rdata/independentUQ_winter_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentUQs.txt"
                     
  # Run model
  set.seed <- 132

  jm.out <- run.independentUQ(dat, 
                              jags.params, 
                              model.loc, 
                              MCMC.params, 
                              seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentUQ_winter_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```

```{r results=FALSE}
if(!file.exists(paste0("Rdata/independentQs_singleU_winter_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentQs_singleU.txt"
  
  # Run model
  set.seed <- 132
  jm.out <- run.independentQs_singleU(dat, 
                                      jags.params, 
                                      model.loc, 
                                      MCMC.params, 
                                      seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentQs_singleU_winter_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```

```{r echo=FALSE}
if(!file.exists(paste0("Rdata/independentUs_singleQ_winter_out_", 
                       begin.year, "_", end.year, "_", run.date, ".rds"))){
  jags.params <- c("U", "Q", "R", "X0", "X", "loglik")
  model.loc <- "models/model_independentUs_singleQ.txt"
  
  # Run model
  set.seed <- 132
  jm.out <- run.independentUs_singleQ(dat, 
                                      jags.params, 
                                      model.loc, 
                                      MCMC.params, 
                                      seed)
  
  jm.out$data <- thedata
  
  saveRDS(jm.out, file = paste0("Rdata/independentUs_singleQ_winter_out_", 
                                begin.year, "_", end.year, "_", run.date, ".rds"))
  print(jm.out$out)
} 
```



```{r}
tmp <- readRDS(paste0("RData/singleUQ_winter_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U1Q1.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentQs_singleU_winter_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U1Q2.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentUQ_winter_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U2Q2.DIC <- tmp$out$DIC
tmp <- readRDS(paste0("RData/independentUs_singleQ_winter_out_", 
                      begin.year, "_", end.year, "_", run.date, ".rds"))
U2Q1.DIC <- tmp$out$DIC

c(U1Q1.DIC, U1Q2.DIC, U2Q2.DIC, U2Q1.DIC)

#minimum is U1Q1
```


```{r}
jags.model_winter <- readRDS(paste0("RData/singleUQ_winter_out_", 
                             begin.year, "_", end.year, "_", run.date, ".rds"))
jags.data_winter <- jags.model_winter$jags.data

# create a dataframe for plotting - need median, upper, and lower 95% limits for each 
# pop

JM.winter.log.df <- data.frame(median = (jags.model_winter$out$q50$X),
                               lower = (jags.model_winter$out$q2.5$X),
                               upper = (jags.model_winter$out$q97.5$X),
                               data = (jags.model_winter$jags.data$Y[1,]),
                               time = thedata$Season,
                               obsd = log(thedata$Winter.observed.JM),
                               loc = 1)

JM.winter.log.df %>% transmute(median = exp(median),
                               lower = exp(lower),
                               upper = exp(upper),
                               data = exp(data),
                               time = time,
                               obsd = exp(obsd),
                               loc = loc) -> JM.winter.df

p.5 <- ggplot(data = JM.winter.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "Nests", title = "Jamursba-Medi (Winter)")

ggsave(p.5, filename = "figures/JM_trend_winter.png",
       device = "png", dpi = 600)

p.5.log <- ggplot(data = JM.winter.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "ln(nests)", title = "Jamursba-Medi (Winter)")

ggsave(p.5.log, filename = "figures/JM_trend_winter_log.png",
       device = "png", dpi = 600)


p.5

```

```{r}
W.winter.log.df <- data.frame(median = jags.model_winter$out$q50$X + jags.model_winter$out$q50$A[2],
                             lower = jags.model_winter$out$q2.5$X + jags.model_winter$out$q2.5$A[2],
                             upper = jags.model_winter$out$q97.5$X + jags.model_winter$out$q97.5$A[2],
                             data = jags.model_winter$jags.data$Y[2,],
                             time = thedata$Season,
                             obsd = log(thedata$Winter.observed.W),
                             loc = 2)

W.winter.log.df %>% transmute(median = exp(median),
                              lower = exp(lower),
                              upper = exp(upper),
                              data = exp(data),
                              time = time,
                              obsd = exp(obsd),
                              loc = loc) -> W.winter.df

p.6 <- ggplot(data = W.winter.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "Nests", title = "Wermon (Winter)")

ggsave(p.6, filename = "figures/W_trend_winter.png",
       device = "png", dpi = 600)

p.6.log <- ggplot(data = W.winter.log.df) + 
  geom_ribbon(aes(x = time, ymin = lower, ymax = upper),
              fill = fill.color,
              alpha = fill.alpha) +
  geom_line(aes(x = time, y = median),
            color = line.color) + 
  geom_point(aes(x = time, y = data),
             color = data.color,
             size = data.size) +
  geom_point(aes(x = time, y = obsd),
             color = obsd.color,
             size = obsd.size)+
  scale_x_continuous(breaks = seq(2001, 2018, by = 2)) +  
  labs(x = "", y = "ln(nests)", title = "Wermon (Winter)")

ggsave(p.6.log, filename = "figures/W_trend_winter_log.png",
       device = "png", dpi = 600)

print(p.6)
```

Look at the posterior of the slope parameter (U).
```{r}
p.1 <- bayesplot::mcmc_dens(jags.model_winter$out$samples, "U")
p.1 <- p.1 + labs(y = "Density")

ggsave(p.1,
       filename = "figures/posterior_U_winter.png",
       device = "png",
       dpi = 600)
print(p.1)
```

```{r}
signif(jags.model_winter$out$summary["U", "f"], 3) * 100
```

